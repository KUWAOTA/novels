<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constrain â€” ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ„ãƒªãƒ¼</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0d1117;
            --bg-surface: #161b22;
            --bg-card: #1c2333;
            --border: #30363d;
            --text: #e6edf3;
            --text-dim: #8b949e;
            --text-muted: #6e7681;
            --accent-preferred: #56d364;
            --accent-candidate: #d29922;
            --accent-deferred: #8b949e;
            --accent-rejected: #f85149;
            --accent-branch: #58a6ff;
            --accent-main: #bc8cff;
            --glow-preferred: rgba(86, 211, 100, 0.15);
            --glow-candidate: rgba(210, 153, 34, 0.15);
            --line-color: #30363d;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Noto Sans JP', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* â”€â”€ Header â”€â”€ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(180deg, var(--bg) 0%, rgba(13, 17, 23, 0.95) 80%, rgba(13, 17, 23, 0) 100%);
            padding: 20px 32px 40px;
            pointer-events: none;
        }

        .header>* {
            pointer-events: auto;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            color: var(--text);
            letter-spacing: 0.5px;
        }

        .header h1 span {
            color: var(--accent-main);
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* â”€â”€ Legend â”€â”€ */
        .legend {
            position: fixed;
            top: 20px;
            right: 32px;
            z-index: 100;
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* â”€â”€ Canvas â”€â”€ */
        .canvas-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            cursor: grab;
        }

        .canvas-wrapper:active {
            cursor: grabbing;
        }

        .canvas {
            position: relative;
            min-width: 3200px;
            min-height: 2400px;
            padding: 100px 60px 60px;
        }

        /* â”€â”€ SVG lines â”€â”€ */
        .lines-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .conn-line {
            stroke: var(--line-color);
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
            transition: opacity 0.3s, stroke 0.3s;
        }

        .conn-line.highlight {
            stroke: var(--accent-branch);
            opacity: 1;
            stroke-width: 2.5;
        }

        /* â”€â”€ Nodes â”€â”€ */
        .node {
            position: absolute;
            z-index: 10;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        .node:hover {
            transform: scale(1.04);
            z-index: 20;
        }

        .node-inner {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            min-width: 200px;
            max-width: 280px;
            position: relative;
            overflow: hidden;
        }

        .node-inner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 12px 0 0 12px;
        }

        .node.status-preferred .node-inner {
            border-color: rgba(86, 211, 100, 0.3);
        }

        .node.status-preferred .node-inner::before {
            background: var(--accent-preferred);
        }

        .node.status-preferred:hover .node-inner {
            box-shadow: 0 0 20px var(--glow-preferred);
        }

        .node.status-candidate .node-inner {
            border-color: rgba(210, 153, 34, 0.3);
        }

        .node.status-candidate .node-inner::before {
            background: var(--accent-candidate);
        }

        .node.status-candidate:hover .node-inner {
            box-shadow: 0 0 20px var(--glow-candidate);
        }

        .node.status-deferred .node-inner {
            border-color: rgba(139, 148, 158, 0.2);
            opacity: 0.7;
        }

        .node.status-deferred .node-inner::before {
            background: var(--accent-deferred);
        }

        .node.status-rejected .node-inner {
            border-color: rgba(248, 81, 73, 0.2);
            opacity: 0.5;
        }

        .node.status-rejected .node-inner::before {
            background: var(--accent-rejected);
        }

        .node.is-act .node-inner {
            background: linear-gradient(135deg, var(--bg-card), #1e2740);
            border-color: rgba(188, 140, 255, 0.3);
        }

        .node.is-act .node-inner::before {
            background: var(--accent-main);
        }

        .node.is-branch-root .node-inner {
            background: linear-gradient(135deg, var(--bg-card), #1c2b3a);
            border-color: rgba(88, 166, 255, 0.3);
        }

        .node.is-branch-root .node-inner::before {
            background: var(--accent-branch);
        }

        .node-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .node-label {
            font-size: 13px;
            font-weight: 500;
            line-height: 1.5;
            color: var(--text);
            margin-bottom: 6px;
        }

        .node-desc {
            font-size: 11px;
            line-height: 1.6;
            color: var(--text-dim);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .node-value {
            margin-top: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--accent-candidate);
            background: rgba(210, 153, 34, 0.08);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .node-status-badge {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .badge-preferred {
            background: rgba(86, 211, 100, 0.15);
            color: var(--accent-preferred);
        }

        .badge-candidate {
            background: rgba(210, 153, 34, 0.15);
            color: var(--accent-candidate);
        }

        .badge-deferred {
            background: rgba(139, 148, 158, 0.1);
            color: var(--accent-deferred);
        }

        .badge-rejected {
            background: rgba(248, 81, 73, 0.1);
            color: var(--accent-rejected);
        }

        .node-issue {
            margin-top: 6px;
            font-size: 10px;
            color: var(--accent-rejected);
            background: rgba(248, 81, 73, 0.08);
            padding: 4px 8px;
            border-radius: 4px;
            line-height: 1.5;
        }

        .node-issue::before {
            content: 'âš  ';
        }

        /* â”€â”€ Detail Panel â”€â”€ */
        .detail-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 200;
            background: linear-gradient(180deg, rgba(13, 17, 23, 0) 0%, var(--bg) 15%, var(--bg-surface) 100%);
            padding: 60px 32px 28px;
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
        }

        .detail-panel.open {
            transform: translateY(0);
        }

        .detail-panel-close {
            position: absolute;
            top: 20px;
            right: 28px;
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .detail-panel-close:hover {
            background: var(--bg-card);
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .detail-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .detail-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .detail-section h3 {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
        }

        .detail-section p {
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-dim);
        }

        .detail-section .mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-candidate);
        }

        /* â”€â”€ Zoom controls â”€â”€ */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 28px;
            z-index: 150;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: var(--bg-card);
        }

        /* â”€â”€ Branch label on lines â”€â”€ */
        .branch-label {
            position: absolute;
            z-index: 5;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--accent-branch);
            background: var(--bg);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(88, 166, 255, 0.2);
            white-space: nowrap;
        }

        /* â”€â”€ Animations â”€â”€ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .node {
            animation: fadeInUp 0.5s ease backwards;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1><span>Constrain</span> â€” ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ„ãƒªãƒ¼</h1>
        <div class="subtitle">âš  ãƒãƒƒã‚­ãƒ¼èª­äº†å‰ã®draft â€” å…¨ã¦ã®åˆ†å²ã¯å¯èƒ½æ€§ã§ã™ã€‚ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’ç¢ºèª</div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot" style="background:var(--accent-preferred)"></div>preferred
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:var(--accent-candidate)"></div>candidate
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:var(--accent-deferred)"></div>deferred
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:var(--accent-main)"></div>å¹• (Act)
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background:var(--accent-branch)"></div>åˆ†å²ç‚¹
        </div>
    </div>

    <div class="canvas-wrapper" id="canvasWrapper">
        <div class="canvas" id="canvas">
            <svg class="lines-svg" id="linesSvg"></svg>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <button class="detail-panel-close" id="detailClose">âœ•</button>
        <div class="detail-header" id="detailHeader"></div>
        <div class="detail-body" id="detailBody"></div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">âˆ’</button>
        <button class="zoom-btn" id="zoomReset" style="font-size:11px;">âŒ‚</button>
    </div>

    <script src="data/ideas.js?v=4"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA â€” All story ideas structured as a tree
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const nodes = window.STORY_NODES;
        /* const nodes_backup = [
            // â”€â”€ Column layout guide â”€â”€
            // col0=80  col1=400  col2=720  col3=1040  col4=1360  col5=1680  col6=2000  col7=2320  col8=2640  col9=2960

            // â”€â”€ ROOT â”€â”€
            { id: 'root', label: 'Constrain', desc: 'è¨€èªã®å³å¯†ã•ã¨æ›–æ˜§ã•ã‚’é€šã˜ã¦ã€äººã¨äººãŒã‚ã‹ã‚Šåˆã†ã“ã¨ãƒ»ä¸–ç•Œã‚’åºƒã’ã‚‹ã“ã¨ã®æœ¬è³ªã«è¿«ã‚‹ç‰©èª', parent: null, status: 'preferred', type: 'root', x: 80, y: 440 },

            // â”€â”€ ACT 1 â”€â”€
            { id: 'act1', label: 'ACT 1 â€” åŸç‚¹\nå†ç¾æ€§ã¸ã®ç›®è¦šã‚', desc: 'å­ä¾›æ™‚ä»£ã€œé’å¹´æœŸã€‚ASDå‚¾å‘ã«ã‚ˆã‚Šç©ºæ°—ãŒèª­ã‚ãšå‚·ã¤ã„ã¦ããŸä¸»äººå…¬ãŒã€å†ç¾æ€§ã¨å³å¯†ãªè¨€èªã«æ•‘ã‚ã‚Œã‚‹ã¾ã§', parent: 'root', status: 'preferred', type: 'act', x: 400, y: 440 },

            { id: 'M-1-1', label: 'ç©ºæ°—ãŒèª­ã‚ãªã„å­¤ç«‹', desc: 'ASDå‚¾å‘ã«ã‚ˆã‚Šå…±æ„Ÿã®ãƒ«ãƒ¼ãƒ«ãŒåˆ†ã‹ã‚‰ãšåœ°é›·ã‚’è¸ã¿ã„ã˜ã‚ã‚‰ã‚Œã‚‹ã€‚Aã‹ã‚‰ç©ºæ°—ãŒèª­ã‚ãªã„ã“ã¨ã‚’æ”»æ’ƒã•ã‚Œã‚‹', parent: 'act1', status: 'preferred', type: 'beat', value: 'å®‰å…¨ â†’ å±é™º (å­¤ç«‹)', x: 720, y: 60 },
            { id: 'M-1-2', label: 'å†ç¾æ€§ã®ç™ºè¦‹', desc: 'æ¯ã®ã€ŒåŠªåŠ›ã—ã‚ã€ã«å†ç¾æ€§ãŒãªã„ã“ã¨ã«æ°—ã¥ãã€‚ã‚«ãƒ•ã‚§ã§é›†ä¸­ã§ãã‚‹æ³•å‰‡ã‚’è‡ªåŠ›ã§ç™ºè¦‹ã€‚ç’°å¢ƒã¨ã„ã†å¤‰æ•°ã«ä¾å­˜ã™ã‚‹ã“ã¨ã‚’å­¦ã¶', parent: 'M-1-1', status: 'preferred', type: 'beat', value: 'ç„¡åŠ› â†’ æ‰‹æ®µã®ç²å¾—', x: 720, y: 220 },
            { id: 'M-1-3', label: 'å…ˆç”Ÿã¨ã®å‡ºä¼šã„', desc: 'æ•°å­¦/ç‰©ç†ã®ç†±ã„å…ˆç”Ÿã¨å‡ºä¼šã„ã€è¨€èªã«ã‚ˆã£ã¦åˆ†ã‹ã‚Šåˆãˆã‚‹ç¾ã—ã•ã‚’çŸ¥ã‚‹ã€‚å®Ÿã¯äººé–“ã¨ã®ç¹‹ãŒã‚ŠãŒç”Ÿã˜ã¦ã„ã‚‹ã®ã«æ°—ã¥ã‹ãªã„', parent: 'M-1-2', status: 'preferred', type: 'beat', value: 'å­¤ç«‹ â†’ ç¹‹ãŒã‚Šã®èŒèŠ½', irony: 'äººé–“ã¨ã®ç¹‹ãŒã‚Šã«æ°—ã¥ã‹ãšã€è¨€èªã®ãƒ«ãƒ¼ãƒ«çš„å´é¢ã ã‘ã‚’å¸å', x: 720, y: 380 },
            { id: 'M-1-4', label: 'ä»®èª¬ãƒ¢ãƒ‡ãƒ«ã§é©å¿œ', desc: 'ä»–è€…ã®è¡Œå‹•ã‚’èª¬æ˜ã™ã‚‹ä»®èª¬ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã€‚å†ç¾å¯èƒ½ãªè¨€èªåŒ–ã§é©å¿œã—ã¦ã„ãã€‚æš—é»™ã®äº†è§£ã§ç”Ÿãã¦ã„ã‚‹ä»–è€…ã‚ˆã‚Šã‚‚ä»–è€…ã®ã“ã¨ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã‚‹', parent: 'M-1-3', status: 'preferred', type: 'beat', value: 'ä¸é©å¿œ â†’ é©å¿œï¼ˆéå‰°é©å¿œã®å…†ã—ï¼‰', x: 720, y: 540 },
            { id: 'M-1-5', label: 'æ‰¿èªã®ç²å¾—', desc: 'åŒã˜ãå‡¸å‡¹ãŒã‚ã‚‹å¥³æ€§ã‹ã‚‰å°Šæ•¬ãƒ»æ‹å¿ƒã‚’æŠ±ã‹ã‚Œã‚‹ã€‚è‡ªä¿¡ã‚’ã¤ã‘ã¦ã„ã', parent: 'M-1-4', status: 'preferred', type: 'beat', value: 'å­¤ç«‹ â†’ æ‰¿èª', x: 720, y: 690 },

            { id: 'act1-climax', label: 'ACT1 ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹\nå†ç¾æ€§ã®çµ¶å¯¾è¦–', desc: 'å†ç¾æ€§ã¨å³å¯†ã•ã“ããŒæ­£ã—ã„ã¨ã„ã†ä¿¡å¿µã‚’ç¢ºç«‹ã€‚æ›–æ˜§ã•ã‚’æ’é™¤ã™ã‚‹æ€æƒ³ã¸ã¨å‚¾å€’ã—å§‹ã‚ã‚‹', parent: 'M-1-5', status: 'preferred', type: 'climax', value: 'å†ç¾æ€§ã‚’çµ¶å¯¾è¦–ã™ã‚‹ä¸–ç•Œè¦³ã®å®Œæˆ', x: 720, y: 850 },

            // â”€â”€ ACT 2 â”€â”€
            { id: 'act2', label: 'ACT 2 â€” ä¸Šæ˜‡ã¨æ­ªã¿\nã„ã‘å¥½ã‹ãªã„ã‚¨ãƒªãƒ¼ãƒˆ', desc: 'ç¤¾ä¼šäººæ™‚ä»£ã€‚æ›–æ˜§ã•ã‚’æ’é™¤ã—ã€Constrainã‚’é–‹ç™ºãƒ»æˆåŠŸã™ã‚‹ã€‚ã—ã‹ã—ç„¡è‡ªè¦šã«åŠ å®³è€…ã«ãªã‚‹', parent: 'act1-climax', status: 'preferred', type: 'act', x: 1040, y: 440 },

            { id: 'M-2-1', label: 'ã‚¨ãƒªãƒ¼ãƒˆåŒ–', desc: 'æ›–æ˜§ãªè¡¨ç¾ã‚’ã™ã‚‹äººã‚’ä¸èª å®Ÿï¼ˆå˜˜ã¤ããƒ»å±é™ºï¼‰ã¨ã¿ãªã™ã‚ˆã†ã«ãªã‚‹ã€‚ã„ã‘å¥½ã‹ãªã„ã‚¨ãƒªãƒ¼ãƒˆã«ãªã‚‹', parent: 'act2', status: 'preferred', type: 'beat', value: 'é©å¿œ â†’ æ”¯é…/æ’ä»–', x: 1280, y: 160 },
            { id: 'M-2-2', label: 'Constrainé–‹ç™º', desc: 'Haskellã§æ›¸ã‹ã‚ŒãŸæ–‡ç« ä½œæˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã€ŒConstrainã€ã‚’é–‹ç™ºã€‚ç†ç§‘ç³»ã®ä½œæ–‡æŠ€è¡“ã«å‰‡ã£ãŸå³å¯†ã§æ˜ç¢ºã§ç´›ã‚Œã®ãªã„æ–‡ã‚’å¼·åˆ¶ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã€‚ä¸»äººå…¬ã®å†™ã—èº«', parent: 'M-2-1', status: 'preferred', type: 'beat', x: 1280, y: 340 },
            { id: 'M-2-3', label: 'ãƒ“ã‚¸ãƒã‚¹æˆåŠŸ', desc: 'ãƒ“ã‚¸ãƒã‚¹å‘ã‘ã«ã‚¦ã‚±ã¦æˆåŠŸã€‚Constrainäº‹æ¥­ã‚’ãƒ™ãƒ³ãƒãƒ£ãƒ¼CTOã¨ã—ã¦çµŒå–¶', parent: 'M-2-2', status: 'preferred', type: 'beat', value: 'èƒ½åŠ› â†’ ç¤¾ä¼šçš„æˆåŠŸ', x: 1280, y: 500 },
            { id: 'M-2-4', label: 'ç«‹å ´ã®é€†è»¢ â€” Aã¸ã®åŠ å®³', desc: 'ä¸‹è«‹ã‘ãƒ†ã‚¹ã‚¿ãƒ¼ã¨ã—ã¦ç™»å ´ã—ãŸAï¼ˆã‹ã¤ã¦ã®ã„ã˜ã‚ã£å­ï¼‰ã‚’å³å¯†ãªè¨€è‘‰ã§è¿½ã„è©°ã‚ã‚‹ã€‚ã„ã˜ã‚ã‚‰ã‚Œã£å­ãŒã„ã˜ã‚ã£å­ã«ã€‚æœ¬äººã¯æ°—ã¥ã„ã¦ã„ãªã„', parent: 'M-2-3', status: 'preferred', type: 'beat', value: 'æ­£ç¾© â†’ åŠ å®³ï¼ˆç„¡è‡ªè¦šï¼‰', irony: 'ã„ã˜ã‚ã‚’ã™ã‚‹äººé–“ãŒå«Œã„ã ã‹ã‚‰Constrainã‚’ä½œã£ãŸã®ã«ã€è‡ªåˆ†ãŒã„ã˜ã‚ã¦ã„ã‚‹', x: 1280, y: 680 },

            // â”€â”€ BRANCHING POINT â”€â”€
            { id: 'branch-point', label: 'ğŸ”€ åˆ†å²ç‚¹\nACT3 ã¸ã®è¤‡æ•°ã®é“', desc: 'ã“ã“ã‹ã‚‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒã„ãã¤ã‹ã®æ–¹å‘ã«åˆ†å²ã™ã‚‹ã€‚ã©ã®ãƒ«ãƒ¼ãƒˆã§ã‚‚æœ€çµ‚çš„ã«ã€Œç‰©äº‹ã¯ãƒ–ãƒ¼ãƒªã‚¢ãƒ³ã§ã¯ãªã„ã€ã€Œæ›–æ˜§ã•ã«ã‚‚ä¾¡å€¤ãŒã‚ã‚‹ã€ã«åˆ°é”ã™ã‚‹', parent: 'M-2-4', status: 'preferred', type: 'branch-point', x: 1600, y: 680 },

            // â•â•â•â•â•â•â•â•â•â•â• BRANCH: faith-collapse (PREFERRED) â•â•â•â•â•â•â•â•â•â•â•
            { id: 'branch-fc', label: 'â˜… ä¿¡ä»°å´©å£Šãƒ«ãƒ¼ãƒˆ\n+-æ€è€ƒã®misleading', desc: 'å†ç¾æ€§ãŒå–„ã‹æ‚ªã‹ã¨+-ã§misleadingã—ã¦ã€ã€Œãã“ã˜ã‚ƒãªã„ã€ã‚‚ã£ã¨ä¿¯ç°ã—ã‚ã€ã¨ä¸Šã‹ã‚‰èª­è€…ã«å©ãã¤ã‘ã‚‹', parent: 'branch-point', status: 'preferred', type: 'branch-root', x: 1920, y: 280 },

            { id: 'FC-1', label: 'Bã¨ã®å‡ºä¼šã„', desc: 'Bã¯ã‚¯ãƒªã‚¨ãƒ¼ã‚¿ãƒ¼ï¼ˆå…ƒå¿ƒç†å£«â†’è¡¨ç¾è€…ï¼‰ã€‚å†ç¾æ€§ãŒã‚ã‚‹è¨€è‘‰ã¯ä½¿ã‚ãªã„ãŒã‚ã¡ã‚ƒãã¡ã‚ƒã§å±…å¿ƒåœ°ãŒã„ã„ã€‚ä¸»äººå…¬ã«æ–°ãŸãªç™ºè¦‹ã‚’ãã‚Œã‚‹', parent: 'branch-fc', status: 'preferred', type: 'beat', value: 'é–‰å¡ â†’ æ–°é®®ã•', x: 2240, y: 30 },
            { id: 'FC-2', label: 'ConstrainãŒè¡¨ç¾ã‚’æ®ºã™', desc: 'BãŒConstrainã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚å½¼å¥³ã®è¡¨ç¾ãŒå³ç‰©çš„ã«ãªã‚Šã€ã‚¦ã‚±ã‚‹ã‚ˆã†ã«ã¯ãªã‚‹ãŒã€Œã“ã‚Œã¯ç§ã˜ã‚ƒãªã„ã€ã¨BãŒè¨€ã†', parent: 'FC-1', status: 'preferred', type: 'beat', value: 'æˆåŠŸ â†’ äº€è£‚', issue: 'ã“ã‚Œã ã‘ã§ã¯å¼±ã„ â€” ã‚‚ã£ã¨ä¸å¯é€†ãªè¡æ’ƒãŒå¿…è¦', x: 2240, y: 200 },
            { id: 'FC-3', label: 'è‰²ã®å–ªå¤±', desc: 'ä¸»äººå…¬ãŒConstrainã‚’é€šã˜ã¦ã—ã‹è©±ã•ãªããªã‚‹ã€‚Bã«ã€Œã‚ãªãŸã«ã¯è‰²ãŒãªããªã£ãŸã€ã€Œä½•ã‚’æ¥½ã—ã¿ã«ç”Ÿãã¦ã‚‹ã®ï¼Ÿã€ã¨å•ã‚ã‚Œã‚‹', parent: 'FC-2', status: 'preferred', type: 'beat', value: 'æ”¯é… â†’ ç©ºè™š', x: 2240, y: 380 },
            { id: 'FC-4', label: 'ç“¦è§£', desc: 'ã€Œä½•ã®ãŸã‚ã«ç”Ÿãã¦ã„ã‚‹ã‹ã€ã«ç­”ãˆã‚‰ã‚Œãªã„ã€‚Bã‹ã‚‰ã€Œè‡ªåˆ†ã®æ„Ÿæƒ…ã«ã™ã‚‰è€³ã‚’å‚¾ã‘ãªã„ã®ã«ã€ã”éƒ½åˆä¸»ç¾©ã§å®šç¾©ã—ãŸã€ç”Ÿãã‚‹ç†ç”±ã€ã«ä¾¡å€¤ãªã‚“ã¦ã‚ã‚‹ã®ï¼Ÿã€', parent: 'FC-3', status: 'preferred', type: 'climax', value: 'ç¢ºä¿¡ â†’ ç“¦è§£', issue: 'ç“¦è§£ãŒå†…é¢çš„ã™ãã¦åˆ†ã‹ã‚Šã¥ã‚‰ã„æ‡¸å¿µ', x: 2240, y: 560 },
            { id: 'FC-5', label: 'èª¤ã£ãŸåå¿œ â€” å…¨å¦å®š', desc: 'å®¢è¦³çš„è¦³æ¸¬æ©Ÿã ã¨ä¿¡ã˜ã¦ã„ãŸã®ã«ä¸å®‰å®šãªæ„Ÿæƒ…ã®ç”£ç‰©ã€‚Constrainã™ã‚‰è¾ã‚ã‚ˆã†ã¨ã™ã‚‹ã€‚äº‹æ¥­æ’¤é€€ã§å¾Œæˆ»ã‚Šã§ããªã„ç—›ã¿ã‚’è² ã†', parent: 'FC-4', status: 'preferred', type: 'beat', value: 'ç“¦è§£ â†’ ç ´å£Šçš„è¡Œå‹•', issue: 'å…¨ã¦æŠ•ã’å‡ºã™=ãƒ–ãƒ¼ãƒªã‚¢ãƒ³æ€è€ƒã€‚ã“ã‚Œã‚‚é–“é•ã„', x: 2240, y: 740 },
            { id: 'FC-6', label: 'æ—…', desc: 'å…¨ã¦æ¨ã¦ã¦æ—…ã«å‡ºã‚‹ã€‚ã„ã‚ã‚“ãªæ¥½ã—ã¿ã«æ°—ã¥ãã€‚Bã®è¨€è‘‰ã‚’ç†è§£ã—ã¦ã„ãã€‚æ„Ÿæƒ…ã¯ãƒã‚¤ã‚ºã§ã¯ãªã„ã€‚Constrainã‚‚é–“é•ã„ã§ã¯ãªã„', parent: 'FC-5', status: 'preferred', type: 'beat', value: 'ç ´å£Š â†’ å†ç™ºè¦‹', x: 2560, y: 640 },
            { id: 'FC-7', label: 'ã„ã˜ã‚ã®è‡ªè¦š', desc: 'è‡ªåˆ†ãŒAã‚’ã„ã˜ã‚ã¦ã„ãŸã“ã¨ã«æ°—ã¥ãã€‚ã„ã˜ã‚ã‚’ã™ã‚‹äººé–“ãŒå«Œã„ã ã‹ã‚‰Constrainã‚’ä½œã£ã¦ã„ãŸã®ã«ã€‚è‡ªå·±å«Œæ‚ª', parent: 'FC-6', status: 'preferred', type: 'beat', value: 'ç„¡è‡ªè¦š â†’ è‡ªå·±å«Œæ‚ª', x: 2880, y: 500 },
            { id: 'FC-8', label: 'Bã«ã‚ˆã‚‹æŠ±æ“', desc: 'ã€Œäººã‚’è‹¦ã—ã‚ãŸæ„Ÿæƒ…ã‚‚ã€è‡ªå·±å«Œæ‚ªã®æ„Ÿæƒ…ã‚‚ã€ä½•ã‚‚ã‹ã‚‚å‚·ã¤ã‘ã¦ç„¡ã‹ã£ãŸã“ã¨ã«ã—ã¦ã¯ãªã‚‰ãªã„ã®ã‚ˆã€ä¸»äººå…¬ã¯ã€ŒæŠ±æ“ãªã‚“ã ã€ã¨æ°—ã¥ã', parent: 'FC-7', status: 'preferred', type: 'beat', value: 'è‡ªå·±å«Œæ‚ª â†’ æŠ±æ“ã®ç†è§£', x: 2880, y: 680 },
            { id: 'FC-9', label: 'Aã¨ã®æŠ±æ“', desc: 'è·é›¢ã‚’ç½®ã‹ã‚Œã¦ã„ãŸAã¨é–¢ä¿‚ã‚’å†æ§‹ç¯‰ã€‚Aã®å®¶åº­ç’°å¢ƒã®å•é¡Œã‚’çŸ¥ã‚‹ã€‚è¡Œå‹•åŸç†ãƒ¬ãƒ™ãƒ«ã§ç†è§£ã—ãŸä¸Šã§æ³£ããªãŒã‚‰æŠ±æ“ã™ã‚‹', parent: 'FC-8', status: 'preferred', type: 'climax', value: 'æ–­çµ¶ â†’ æŠ±æ“', x: 2880, y: 860 },
            { id: 'FC-end', label: 'ã€Œæ—…ã¯æ¥½ã—ã‹ã£ãŸï¼Ÿã€', desc: 'Bã«ã€Œæ—…ã¯æ¥½ã—ã‹ã£ãŸï¼Ÿã€ã¨èã‹ã‚Œã‚‹ã€‚ç‰©äº‹ã¯ãƒ–ãƒ¼ãƒªã‚¢ãƒ³ã§ã¯ãªã„ã€‚å†ç¾æ€§ã¯é–“é•ã„ã§ã¯ãªã„ã€‚æ›–æ˜§ã•ã«ã‚‚ä¾¡å€¤ãŒã‚ã‚‹', parent: 'FC-9', status: 'preferred', type: 'ending', x: 3200, y: 860 },

            // â•â•â•â•â•â•â•â•â•â•â• BRANCH: romance-crisis (DEFERRED) â•â•â•â•â•â•â•â•â•â•â•
            { id: 'branch-rc', label: 'â¸ æ‹æ„›ã‚¯ãƒ©ã‚¤ã‚·ã‚¹ãƒ«ãƒ¼ãƒˆ', desc: 'Bã¨Constrainã®è¡çªã‚’æ‹æ„›ã®ã‚¯ãƒ©ã‚¤ã‚·ã‚¹ã«ã™ã‚‹ãƒ«ãƒ¼ãƒˆã€‚ã€Œã“ã‚“ãªé‡ã„è©±æ›¸ã„ã¦ã‚‹ã®ã«ãŸã‹ãŒæ‹æ„›ã‚’ã‚¯ãƒ©ã‚¤ã‚·ã‚¹ã«ã—ãŸããªã„ã€', parent: 'branch-point', status: 'deferred', type: 'branch-root', x: 1920, y: 1000 },
            { id: 'RC-1', label: 'è¡¨ç¾ãŒæ­»ã¬', desc: 'BãŒConstrainã‚’ä½¿ã„ã€è¡¨ç¾ãŒæ­»ã¬', parent: 'branch-rc', status: 'deferred', type: 'beat', x: 2240, y: 1000 },
            { id: 'RC-2', label: 'ã€Œè‰²ãŒãªããªã£ãŸã€ã˜ã‚ƒã‚ã­ã€', desc: 'åˆ¥ã‚Œã‚’åˆ‡ã‚Šå‡ºã•ã‚Œã‚‹', parent: 'RC-1', status: 'deferred', type: 'beat', x: 2560, y: 1000 },
            { id: 'RC-3', label: 'æ‹äººã®å–ªå¤±ã§å¤‰ã‚ã‚‹', desc: 'æ‹äººã®å–ªå¤±ã‚’ãã£ã‹ã‘ã«ä¸»äººå…¬ãŒå¤‰ã‚ã‚‹', parent: 'RC-2', status: 'deferred', type: 'beat', x: 2880, y: 1000 },
            { id: 'rc-issue', label: 'âŒ ãƒ†ãƒ¼ãƒã®é‡ã•ã«å¯¾ã—ã¦å¼±ã„', desc: 'ãƒ†ãƒ¼ãƒã®é‡ã•ã«å¯¾ã—ã¦æ‹æ„›ãŒã‚¯ãƒ©ã‚¤ã‚·ã‚¹ã§ã¯å¼±ã„ã€‚ã‚‚ã£ã¨å®Ÿå­˜çš„ãªè¡æ’ƒãŒå¿…è¦', parent: 'branch-rc', status: 'rejected', type: 'note', x: 2240, y: 1160 },

            // â•â•â•â•â•â•â•â•â•â•â• BRANCH: travel-awakening (CANDIDATE) â•â•â•â•â•â•â•â•â•â•â•
            { id: 'branch-ta', label: '? æ—…ã§ã®è¦šé†’ãƒ«ãƒ¼ãƒˆ', desc: 'å…¨ã¦æ¨ã¦ã¦æ—…ã«å‡ºã‚‹ã€‚æ—…ã®ä¸­ã§ill-definedãªè¨€èªã®æŒã¤å‰µé€ æ€§ãƒ»å†’é™ºæ€§ã«è§¦ã‚Œã€æ›–æ˜§ã•ã®ä¾¡å€¤ã«æ°—ã¥ã', parent: 'FC-5', status: 'candidate', type: 'branch-root', x: 2560, y: 820 },
            { id: 'TA-1', label: 'è¨€è‘‰ã§ä¸–ç•Œã‚’è¦‹ã›ã¦ã‚‚ã‚‰ã†', desc: 'ä»–è€…ã®é ­ã®ä¸­ã§æãå‡ºã•ã‚ŒãŸä¸–ç•ŒãŒè‡ªåˆ†ã®ã¨é•ã£ã¦ã‚‚è±Šã‹ã€‚ã€Œã“ã‚“ãªç¾è±¡ã‚’strictly definedãªè¨€è‘‰ã§æ‰±ãˆã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ ã‚€ã‚Šã§ã™ã€', parent: 'branch-ta', status: 'candidate', type: 'beat', x: 2560, y: 980 },

            // â•â•â•â•â•â•â•â•â•â•â• BRANCH: constrain-evangelism (CANDIDATE) â•â•â•â•â•â•â•â•â•â•â•
            { id: 'branch-ce', label: '? Constrainå¸ƒæ•™â†’æš´èµ°', desc: 'ä¸»äººå…¬ãŒConstrainã‚’æ™®åŠã•ã›ã™ãã¦ã€è‡ªåˆ†è‡ªèº«ã‚‚Constrainã‚’é€šã˜ã¦ã—ã‹èª°ã¨ã‚‚å–‹ã‚‰ãªããªã‚‹ã€‚è‰²ãŒæ¶ˆãˆãŸä¸–ç•Œã«æ°—ã¥ã', parent: 'branch-point', status: 'candidate', type: 'branch-root', x: 1920, y: 1340 },
            { id: 'CE-1', label: 'Constrainã§ã—ã‹è©±ã•ãªã„', desc: 'Constrainã‚’é€šã˜ã¦ã—ã‹è©±ã•ãªããªã‚‹ â†’ ã€Œä½•ã‚’æ¥½ã—ã¿ã«ç”Ÿãã¦ã‚‹ã®ã€ã¨å•ã‚ã‚Œã‚‹ â†’ ç”Ÿãã‚‹æ„å‘³ã‚ã‚‹ã®ã‹ï¼Ÿ', parent: 'branch-ce', status: 'candidate', type: 'beat', x: 2240, y: 1340 },
            { id: 'ce-note', label: 'çµ±åˆå¯èƒ½', desc: 'branch/faith-collapse ã¨çµ±åˆå¯èƒ½ã€‚ä¿¡ä»°å´©å£Šãƒ«ãƒ¼ãƒˆã®ä¸€è¦ç´ ã¨ã—ã¦ä½¿ãˆã‚‹', parent: 'branch-ce', status: 'candidate', type: 'note', x: 2240, y: 1500 },

            // â•â•â•â•â•â•â•â•â•â•â• BRANCH: single-focus (DEFERRED) â•â•â•â•â•â•â•â•â•â•â•
            { id: 'branch-sf', label: 'â¸ å˜ä¸€è²¬ä»»ãƒ«ãƒ¼ãƒˆ\nå³å¯†ã•ç²å¾—ã®ã¿', desc: 'æ›–æ˜§ã•ã®å—å®¹ãƒ‘ãƒ¼ãƒˆã‚’å‰Šã‚Šã€å†ç¾æ€§ãƒ»å³å¯†ã•ã‚’ç²å¾—ã™ã‚‹ã¾ã§ã ã‘ã®ç‰©èªã€‚åˆ¥ã®ä½œå“ã¨ã—ã¦æ›¸ãå¯èƒ½æ€§', parent: 'act1', status: 'deferred', type: 'branch-root', x: 240, y: 900 },
            { id: 'sf-issue-1', label: 'è‘›è—¤ãŒãªã„å•é¡Œ', desc: 'è§£åƒåº¦ãŒã©ã‚“ã©ã‚“ä¸ŠãŒã‚‹ã ã‘ã§è‘›è—¤ãŒã§ããªããªã‚‹', parent: 'branch-sf', status: 'deferred', type: 'note', x: 240, y: 1100 },
            { id: 'sf-issue-2', label: 'äºŒã¤ã®è©±ã‚’æ··ãœã¦ã‚‹ï¼Ÿ', desc: 'æ›–æ˜§ã•ã«è¡Œãã¨ã“ã‚ã®æå†™ã«é£›èºãŒãªã„ã‹ã€‚åˆ¥ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’äºŒã¤æ··ãœã¦ã„ã‚‹ã ã‘ã‹ã‚‚ï¼ˆæ·±æ˜ã‚ŠãŒè¶³ã‚Šãªã„ã ã‘ã‹ã‚‚ã—ã‚Œãªã„ï¼‰', parent: 'branch-sf', status: 'deferred', type: 'note', x: 540, y: 1100 },

            // â”€â”€ COMMON RESOLUTION â”€â”€
            { id: 'resolution', label: 'å…±é€šã®åˆ°é”ç‚¹', desc: 'å†ç¾æ€§ã¯é–“é•ã„ã§ã¯ãªã„ã€‚ç‰©äº‹ã¯ãƒ–ãƒ¼ãƒªã‚¢ãƒ³ã§ã¯ãªã„ã€‚æ›–æ˜§ã•ã«ã‚‚ä¾¡å€¤ãŒã‚ã‚‹ã€‚æ„Ÿæƒ…ã¯ãƒã‚¤ã‚ºã§ã¯ãªã„ã€‚Constrainã‚‚é–“é•ã„ã§ã¯ãªã„ã€‚Aã‚’è¡Œå‹•åŸç†ãƒ¬ãƒ™ãƒ«ã§ç†è§£ã—æ³£ããªãŒã‚‰æŠ±æ“', parent: null, status: 'preferred', type: 'resolution', x: 3200, y: 440 },
        ]; */

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const canvas = document.getElementById('canvas');
        const svg = document.getElementById('linesSvg');
        const detailPanel = document.getElementById('detailPanel');
        const canvasWrapper = document.getElementById('canvasWrapper');

        // Calculate required canvas size
        let maxX = 0, maxY = 0;
        nodes.forEach(n => {
            if (n.x + 320 > maxX) maxX = n.x + 320;
            if (n.y + 200 > maxY) maxY = n.y + 200;
        });
        canvas.style.minWidth = (maxX + 100) + 'px';
        canvas.style.minHeight = (maxY + 100) + 'px';

        // Draw nodes
        const nodeElements = {};
        nodes.forEach((n, i) => {
            const el = document.createElement('div');
            const classes = ['node', `status-${n.status}`];
            if (n.type === 'act') classes.push('is-act');
            if (n.type === 'branch-root' || n.type === 'branch-point') classes.push('is-branch-root');
            el.className = classes.join(' ');
            el.style.left = n.x + 'px';
            el.style.top = n.y + 'px';
            el.style.animationDelay = (i * 0.03) + 's';
            el.dataset.id = n.id;

            let inner = `<div class="node-inner">`;
            inner += `<span class="node-status-badge badge-${n.status}">${n.status}</span>`;
            inner += `<div class="node-id">${n.id}</div>`;
            inner += `<div class="node-label">${n.label.replace(/\n/g, '<br>')}</div>`;
            inner += `<div class="node-desc">${n.desc}</div>`;
            if (n.value) inner += `<div class="node-value">${n.value}</div>`;
            if (n.issue) inner += `<div class="node-issue">${n.issue}</div>`;
            inner += `</div>`;
            el.innerHTML = inner;

            el.addEventListener('click', () => showDetail(n));
            canvas.appendChild(el);
            nodeElements[n.id] = el;
        });

        // Draw connections
        function getNodeCenter(el) {
            const rect = el.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            return {
                x: el.offsetLeft + el.offsetWidth / 2,
                y: el.offsetTop + el.offsetHeight / 2,
                right: el.offsetLeft + el.offsetWidth,
                left: el.offsetLeft,
                top: el.offsetTop,
                bottom: el.offsetTop + el.offsetHeight,
                width: el.offsetWidth,
                height: el.offsetHeight
            };
        }

        function drawLines() {
            // Wait for layout
            requestAnimationFrame(() => {
                svg.innerHTML = '';
                nodes.forEach(n => {
                    if (!n.parent) return;

                    const parents = Array.isArray(n.parent) ? n.parent : [n.parent];

                    parents.forEach(parentId => {
                        if (!nodeElements[parentId] || !nodeElements[n.id]) return;

                        const from = getNodeCenter(nodeElements[parentId]);
                        const to = getNodeCenter(nodeElements[n.id]);

                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

                        // Determine connection points
                        let x1, y1, x2, y2;
                        const dx = to.left - from.right;

                        if (dx > -20) {
                            // Target is to the right
                            x1 = from.right;
                            y1 = from.y;
                            x2 = to.left;
                            y2 = to.y;
                        } else if (to.top > from.bottom) {
                            // Target is below
                            x1 = from.x;
                            y1 = from.bottom;
                            x2 = to.x;
                            y2 = to.top;
                        } else {
                            x1 = from.right;
                            y1 = from.y;
                            x2 = to.left;
                            y2 = to.y;
                        }

                        const midX = (x1 + x2) / 2;
                        const d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                        path.setAttribute('d', d);
                        path.classList.add('conn-line');
                        path.dataset.from = parentId;
                        path.dataset.to = n.id;

                        if (n.status === 'preferred') {
                            path.style.stroke = 'rgba(86,211,100,0.3)';
                        } else if (n.type === 'branch-root' || n.type === 'branch-point') {
                            path.style.stroke = 'rgba(88,166,255,0.3)';
                        }

                        svg.appendChild(path);
                    });
                });

                // Draw special connection: resolution
                const branchFc = nodeElements['FC-end'];
                const resolution = nodeElements['resolution'];
                if (branchFc && resolution) {
                    const from = getNodeCenter(branchFc);
                    const to = getNodeCenter(resolution);
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const x1 = from.right; const y1 = from.y;
                    const x2 = to.left; const y2 = to.y;
                    const midX = (x1 + x2) / 2;
                    path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                    path.classList.add('conn-line');
                    path.style.stroke = 'rgba(86,211,100,0.4)';
                    path.style.strokeDasharray = '6,4';
                    svg.appendChild(path);
                }
            });
        }

        setTimeout(drawLines, 100);
        window.addEventListener('resize', drawLines);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DETAIL PANEL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function showNodeDetail(node) {
            const panel = document.getElementById('detailPanel');
            const header = document.getElementById('detailHeader');
            const body = document.getElementById('detailBody');

            // Header color based on status
            const statusColors = {
                preferred: 'var(--accent-preferred)',
                candidate: 'var(--accent-candidate)',
                deferred: 'var(--accent-deferred)',
                rejected: 'var(--accent-rejected)'
            };
            const color = statusColors[node.status] || 'var(--text)';

            header.innerHTML = `
                <div style="width:12px; height:12px; border-radius:50%; background:${color};"></div>
                <h2 style="margin:0; flex:1;">${escapeHtml(node.label.replace(/\n/g, ' â€” '))}</h2>
                <span class="mono" style="opacity:0.5; font-size:11px;">ID: ${node.id}</span>
            `;

            body.innerHTML = `
                <div class="detail-section" style="grid-column: 1 / -1;">
                    <h3>Description</h3>
                    <p style="font-size:14px; white-space: pre-wrap;">${escapeHtml(node.desc || 'No description.')}</p>
                </div>
                ${node.value ? `
                <div class="detail-section">
                    <h3>Value Charge</h3>
                    <span class="node-value">${escapeHtml(node.value)}</span>
                </div>` : ''}
                <div class="detail-section">
                    <h3>Status</h3>
                    <span class="node-status-badge badge-${node.status}" style="position:static;">${node.status}</span>
                </div>
                <div class="detail-section" style="grid-column: 1 / -1; margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                     <h3>Edit Controls (Experimental)</h3>
                     <p style="font-size:11px; opacity:0.7;">Drag nodes to rearrange. Double click to edit text (Not implemented yet).</p>
                </div>
            `;

            panel.classList.add('open');

            // Highlight connected lines
            document.querySelectorAll('.conn-line').forEach(l => l.classList.remove('highlight'));
            document.querySelectorAll(`.conn-line[data-to="${node.id}"], .conn-line[data-from="${node.id}"]`).forEach(l => l.classList.add('highlight'));
        }

        // â”€â”€ Drag and Drop Implementation â”€â”€
        let isDragging = false;
        let dragNode = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        document.getElementById('canvas').addEventListener('mousedown', e => {
            const potentialNode = e.target.closest('.node');
            if (potentialNode) {
                isDragging = true;
                dragNode = potentialNode;
                const rect = dragNode.getBoundingClientRect();
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
                dragNode.style.zIndex = 100;
                e.stopPropagation(); // Prevent canvas panning
            }
        });

        document.addEventListener('mousemove', e => {
            if (!isDragging || !dragNode) return;

            // Calculate new position relative to canvas
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            const x = e.clientX - canvasRect.left - dragOffsetX;
            const y = e.clientY - canvasRect.top - dragOffsetY;

            dragNode.style.left = `${x}px`;
            dragNode.style.top = `${y}px`;

            // Update lines while dragging
            requestAnimationFrame(drawLines);
        });

        document.addEventListener('mouseup', () => {
            if (isDragging && dragNode) {
                isDragging = false;
                dragNode.style.zIndex = '';

                // Update underlying data model (in a real app, you'd save this)
                const nodeId = dragNode.dataset.id;
                const nodeData = nodes.find(n => n.id === nodeId);
                if (nodeData) {
                    nodeData.x = parseInt(dragNode.style.left);
                    nodeData.y = parseInt(dragNode.style.top);
                    console.log(`Updated position for ${nodeId}: x=${nodeData.x}, y=${nodeData.y}`);
                }
                dragNode = null;
            }
        });

        document.getElementById('detailClose').addEventListener('click', () => {
            detailPanel.classList.remove('open');
            document.querySelectorAll('.conn-line').forEach(l => l.classList.remove('highlight'));
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ZOOM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let scale = 1;
        function setZoom(s) {
            scale = Math.max(0.3, Math.min(2, s));
            canvas.style.transform = `scale(${scale})`;
            canvas.style.transformOrigin = '0 0';
        }

        document.getElementById('zoomIn').addEventListener('click', () => setZoom(scale + 0.15));
        document.getElementById('zoomOut').addEventListener('click', () => setZoom(scale - 0.15));
        document.getElementById('zoomReset').addEventListener('click', () => { setZoom(1); canvasWrapper.scrollTo(0, 200); });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EDITOR MODE (Collaboration UI)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // 1. Create Editor UI Elements
        const editorBtn = document.createElement('button');
        editorBtn.textContent = 'ï¼‹ ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¿½åŠ ';
        editorBtn.className = 'zoom-btn'; // Reuse style + overwrite
        editorBtn.style.width = 'auto';
        editorBtn.style.padding = '0 16px';
        editorBtn.style.fontSize = '12px';
        editorBtn.style.fontWeight = '600';
        editorBtn.style.background = 'var(--accent-branch)';
        editorBtn.style.borderColor = 'transparent';
        editorBtn.style.marginBottom = '10px';
        editorBtn.onclick = openEditor;

        document.querySelector('.zoom-controls').prepend(editorBtn);

        const editorPanel = document.createElement('div');
        editorPanel.className = 'detail-panel'; // Reuse panel style
        editorPanel.style.height = '60vh';
        editorPanel.style.maxHeight = '60vh';
        editorPanel.style.zIndex = '250';
        editorPanel.id = 'editorPanel';
        editorPanel.innerHTML = `
            <button class="detail-panel-close" id="editorClose">âœ•</button>
            <div class="detail-header" style="margin-bottom:8px;">
                <h2 style="font-size:16px;">ğŸ’¡ æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ææ¡ˆ</h2>
            </div>
            <p style="font-size:11px; color:var(--text-muted); margin-bottom:16px; line-height:1.4;">
                å¤‰æ›´ã«é–‹ã„ãŸè¨­è¨ˆã«ã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã¯ <code>data/ideas.js</code> ã«åˆ†é›¢ã•ã‚Œã¾ã—ãŸã€‚<br>
                ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…¥åŠ›ã—ã€<strong>ã€ŒIssueã§ææ¡ˆã€</strong>ã™ã‚‹ã¨ã€ç®¡ç†è€…ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åæ˜ ã—ã¾ã™ã€‚
            </p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
                <div>
                    <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">è¦ªãƒãƒ¼ãƒ‰ (Parent)</label>
                    <select id="editParent" style="width:100%; padding:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:12px;"></select>
                </div>
                <div>
                    <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">ID (ä¾‹: FC-10)</label>
                    <input id="editId" type="text" placeholder="è‡ªå‹•ç”Ÿæˆ" style="width:100%; padding:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:12px;">
                </div>
            </div>

            <div style="margin-bottom:12px;">
                <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">ã‚¿ã‚¤ãƒˆãƒ« (Label)</label>
                <input id="editLabel" type="text" style="width:100%; padding:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:12px;">
            </div>

            <div style="margin-bottom:12px;">
                <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">å†…å®¹ãƒ»è©³ç´° (Description)</label>
                <textarea id="editDesc" rows="3" style="width:100%; padding:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-family:sans-serif; font-size:12px;"></textarea>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
                 <div>
                    <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="editStatus" style="width:100%; padding:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:12px;">
                        <option value="candidate">Candidate (å€™è£œ)</option>
                        <option value="preferred">Preferred (æœ‰åŠ›)</option>
                        <option value="deferred">Deferred (ä¿ç•™)</option>
                        <option value="rejected">Rejected (å´ä¸‹)</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:4px;">ä¾¡å€¤å¤‰åŒ– (Value Change)</label>
                    <input id="editValue" type="text" placeholder="ä¾‹: çµ¶æœ› â†’ å¸Œæœ›" style="width:100%; padding:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); border-radius:6px; font-size:12px;">
                </div>
            </div>

            <div style="display:flex; gap:12px;">
                <a id="btnIssue" target="_blank" href="#" style="flex:1; text-align:center; padding:10px; background:var(--bg-card); border:1px solid var(--border); border-radius:6px; color:var(--text); text-decoration:none; font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:0.2s;">
                    <span style="font-size:14px;">ğŸ™</span> Issueã§ææ¡ˆ
                </a>
                <button id="btnCopy" style="flex:1; padding:10px; background:var(--accent-branch); border:none; border-radius:6px; color:white; font-weight:600; cursor:pointer; font-size:12px;">
                    ğŸ“‹ YAMLã‚³ãƒ”ãƒ¼
                </button>
            </div>
        `;
        document.body.appendChild(editorPanel);

        // 2. Logic
        function openEditor() {
            const select = document.getElementById('editParent');
            select.innerHTML = '';
            // Sort nodes by ID for easier finding
            const sorted = [...nodes].sort((a, b) => a.id.localeCompare(b.id));
            sorted.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.id;
                opt.textContent = `${n.id}: ${n.label.replace(/\\n/g, ' ')}`;
                select.appendChild(opt);
            });
            editorPanel.classList.add('open');
            document.getElementById('detailPanel').classList.remove('open');
            updateIssueLink();
        }

        document.getElementById('editorClose').addEventListener('click', () => {
            editorPanel.classList.remove('open');
        });

        function generateYAML() {
            const id = document.getElementById('editId').value || 'NEW-ID';
            const label = document.getElementById('editLabel').value || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
            const desc = document.getElementById('editDesc').value || '';
            const parent = document.getElementById('editParent').value;
            const status = document.getElementById('editStatus').value;
            const value = document.getElementById('editValue').value;

            return `- id: ${id}\n  label: "${label}"\n  description: >\n    ${desc.replace(/\\n/g, '\\n    ')}\n  parent: "${parent}"\n  status: ${status}\n  type: beat${value ? `\n  value_change: "${value}"` : ''}`;
        }

        function updateIssueLink() {
            const yaml = generateYAML();
            const label = document.getElementById('editLabel').value || 'New Idea';
            const desc = document.getElementById('editDesc').value || '';
            const title = `[Idea]: ${label}`;
            const body = `æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã®ææ¡ˆã§ã™ã€‚\n\n\`\`\`yaml\n${yaml}\n\`\`\`\n\n**æ¦‚è¦:**\n${desc}`;

            const btn = document.getElementById('btnIssue');
            btn.href = `https://github.com/KUWAOTA/novels/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
        }

        document.getElementById('btnCopy').addEventListener('click', () => {
            const yaml = generateYAML();
            navigator.clipboard.writeText(yaml).then(() => {
                const btn = document.getElementById('btnCopy');
                const orig = btn.textContent;
                btn.textContent = 'âœ… Copied!';
                setTimeout(() => { btn.textContent = orig; }, 2000);
            });
        });

        ['editId', 'editLabel', 'editDesc', 'editParent', 'editStatus', 'editValue'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateIssueLink);
            document.getElementById(id).addEventListener('change', updateIssueLink);
        });

        // Initial scroll to show root
        setTimeout(() => { canvasWrapper.scrollTo(0, 200); }, 200);
    </script>
</body>

</html>